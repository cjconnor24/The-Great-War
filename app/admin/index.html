<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Admin - The Great War Guide</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h"
        crossorigin="anonymous">
    <link rel="stylesheet" href="/css/admin.css">
    <!-- <link rel="stylesheet" href="/css/styles.css"> -->
</head>

<body>
    <header>

        <div class="header-row">

            <!-- <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div> -->

            <div class="logo">
                <a href="/">
                    <p>
                        THE <span>GREAT</span> WAR
                    </p>
                    <p class="sub">An Interactive Guide</p>
                </a>
            </div>

            <!-- <div class="search"></div> -->

        </div>

        <nav>

            <h1>Main Menu</h1>

            <ul>
                <li><a href="#/">Loading... <i class="fa-spinner fas fa-sync fa-spin"></i> </a></li>
            </ul>

        </nav>

    </header>


    <div class="container">

        <h1>Admin</h1>
        <p>This is the admin page</p>



        <div id="page-module">
            <table><tr><td>
                    <div class="spinner">
                            <img src="/img/poppy.png" class="poppy" alt="POPPY">
                            <h1>Pages loading...</h1>
                        </div>
            </td></tr></table>

            <h2>Page Management</h2>
            <p>To create or edit a page, please use the form below.</p>



            <form action="">

                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" name="title" value="">
                </div>

                <div class="form-group">
                    <label for="subtitle">Subtitle</label>
                    <input type="text" name="subtitle" value="">
                </div>

                <div class="markdown">
                    <h3>Markdown</h3>
                    <p>There is a very crude markdown system in place.</p>
                    <ul>
                        <li>Line breaks will be converted to paragraph tags</li>
                        <li><code>%img=image-name.jpg</code> will be converted to an image tag</li>
                        <li><code>#Heading</code> will be converted to a heading tag</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="contect">Content</label>
                    <textarea id="" cols="30" rows="10" name="content"></textarea>
                </div>

                <div class="form-group">
                    <label for="img">Image URL</label>
                    <input type="text" name="img" value="">
                </div>

                <div class="form-group">
                    <label for="active">Published?</label>
                    Yes <input type="radio" value="1" name="active" checked>
                    No <input type="radio" value="0" name="active">
                </div>

                <button type="submit">Create Page</button>
                <button type="reset">Clear Form</button>

            </form>

        </div>


    </div>

    <script>

        // VERY CRUDE AND DAFT LOGIN...MORE FOR DEMO PURPOSES.
        // IF THIS WAS IMPLEMENTS FOR REAL, WOULD LEVERAGE JSON TOKENS
        // var username, password, count = 0;

        // do {

        //     username = prompt("Please enter your name", "chrisconnor");
        //     password = prompt("Please enter your password", "password");

        //     if(username !== "chrisconnor" && password !== "password"){
        //         alert('those credentials were wrong...'+(count==1 ? 'careful, last chance...' : ''));
        //         count++;
        //     }

        //     if(count===3){
        //         alert('You have made three incorrect attempts. Goodbye.');
        //         window.location = "/";
        //         break;
        //     }





        // } while(username !== "chrisconnor" && password !== "password");

        // PageModule.init();

        var PageModule = (function () {


            // DOM CONTAINERS
            var container = document.querySelector('#page-module');
            var list = document.querySelector('#page-module table');
            var button = document.querySelector('#page-module button[type=submit]')
            var form = document.querySelector('#page-module form');
            var allowedFields = ['text', 'email', 'radio', 'textarea'];
            var template = function (page, index) {
                return `<tr data-page-index="${index}">
                        <td><i class="far fa-file"></i> <span>${page.title}</span></td>
                        <td><button><i class="fas fa-trash"></i> Delete</button> <button><i class="fas fa-edit"></i> Edit</button></td>
                        </tr>`;
            }

            // EVENT LISTENERS
            button.addEventListener('click', addPage);
            list.addEventListener('click', manageButtons);

            // STATE
            var pages = [];


            // UI METHODS
            function _render() {

                console.log(pages);

                list.innerHTML = pages.reduce((html, page, index) => {
                    return html + template(page, index);
                }, '');

            }

            function init() {
                loadPages();
            }

            function clearform() {
                for (var i = 0; i < form.elements.length; i++) {

                    var field = form.elements[i];
                    if (field.type == 'text' || field.type == 'textarea') {
                        field.value = '';
                    }

                }

                form.elements[0].focus();

            }


            // FUNCTIONAL METHODS
            function addPage(event) {

                event.preventDefault();
                var pageObject = {};

                for (var i = 0; i < form.elements.length; i++) {

                    var field = form.elements[i];
                    // console.log(formFields.elements[i]);
                    if (allowedFields.indexOf(field.type) !== -1) {

                        // CHECK THE RADIO BUTTON
                        if (field.type == 'radio') {

                            (field.checked ? pageObject[field.name] = field.value : '');

                        } else {

                            console.log(field.name);

                            pageObject[field.name] = (field.name == 'content' ? encodeContent(field.value) : field.value);

                        }



                    }
                }

                // CONVERT THE SLUG
                pageObject.slug = _getSlug(pageObject.title);



                savePage(pageObject);

                pages.push(pageObject);
                clearform();
                _render();

            }

            function manageButtons(event) {




                if (event.target.innerText.trim().toLowerCase() == "delete") {

                    deletePage(event);

                } else if (event.target.innerText.trim().toLowerCase() === "edit") {

                    editPage(event);

                }


            }


            function encodeContent(content) {

                // TRIM RETURNS
                var newContent = content.replace(/\n+/gi, '%return%');
                return newContent;

            }

            function decodeContent(content) {
                var newContent = content.replace(/%return%/gi, '\n\n');
                return newContent;
            }

            function deletePage(event) {

                var checker = confirm('Are you sure you want to delete this page...?');


                if (checker) {

                    var el = event.target.closest('tr')
                    var listIndex = el.getAttribute('data-page-index');
                    console.log(listIndex);
                    console.log(event.target);

                    var removedPage = pages.splice(listIndex, 1);
                    removeDB(removedPage[0].slug);
                    _render();

                }


            }

            async function removeDB(slug) {

                var result = await fetch("http://10.0.0.45:8080/admin-pages-api.php?mode=delete&slug=" + slug);
                var test = await result.text();
                console.log(test);

                // $.post("http://10.0.0.45:8080/admin-pages-api.php?mode=delete&slug", page, function () {
                //     alert("success");
                // })

            }

            function _getSlug(title) {

                return title.replace(/[\"\@\-\'\.\!\s\?\//]+/gi, '-').toLowerCase();

            }

            function editPage(event) {


                var listIndex = event.target.closest('tr').getAttribute('data-page-index');

                var page = pages[listIndex];

                for (var i = 0; i < form.elements.length; i++) {

                    var field = form.elements[i];

                    if (allowedFields.indexOf(field.type) !== -1) {



                        field.value = (field.name == 'content' ? decodeContent(page[field.name]) : page[field.name]);

                    }


                }

                alert('WARNING: EDIT IS MEGA BUGGY. DO NOT USE.');

            }

            async function loadPages() {

                var data = await fetch('http://10.0.0.45:8080/admin-pages-api.php');
                var json = await data.json();
                pages = json;
                _render();

            }

            function savePage(page) {

                $.post("http://10.0.0.45:8080/admin-pages-api.php?mode=insert", page, function () {
                    alert("success");
                })
                    .done(function () {
                        alert("second success");
                    });


            }

            return {
                init: init
            }



        }());

        PageModule.init();
    </script>
    <script src="/admin/js/jquery.3.1.1.min.js"></script>

</body>

</html>